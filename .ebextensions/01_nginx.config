files:
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      upstream docker {
        server 172.17.0.1:8080;
        keepalive 256;
      }

      server {
        listen 80;

        location / {
            proxy_pass  http://docker;
            proxy_http_version  1.1;
            proxy_set_header    Connection          $connection_upgrade;
            proxy_set_header    Upgrade             $http_upgrade;
            proxy_set_header    Host                $host;
            proxy_set_header    X-Real-IP           $remote_addr;
            proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        }

        location /health {
            access_log off;
            proxy_pass  http://docker;
        }
      }

option_settings:
  aws:elasticbeanstalk:application:environment:
    PORT: 8080
  aws:autoscaling:asg:
    MinSize: 2
    MaxSize: 4
  aws:autoscaling:trigger:
    UpperThreshold: 70
    LowerThreshold: 30
    MeasureName: CPUUtilization
    Unit: Percent
    UpperBreachScaleIncrement: 1
    LowerBreachScaleIncrement: -1
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx